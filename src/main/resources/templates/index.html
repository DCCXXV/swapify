<!DOCTYPE html>
<html class="h-100" xmlns:th="http://www.thymeleaf.org">

	<head>
		<th:block th:replace="fragments/head :: header" />
		<title>Inicio | Swapify</title>
		<script th:inline="javascript">
			const users = [[${otherusers}]];
			const me = [[${me}]];
		</script>
	</head>

	<body class="d-flex flex-column h-100 bg-abaloneshell">
		<header th:replace="fragments/nav.html :: nav"></header>
		<main class="flex-shrink-0">
			<div class="container">
				<!--
				<h2 class="mt-4 fg-orchid bold">Usuarios recomendados</h2>
				<hr class="hr-swp">

				<h4 class="fg-orchid ms-2 mb-3">Filtrando por: </h4>
				<div class="d-flex align-items-center mb-2 bg-abaloneshell-l0 p-2 rounded-pill justify-content-between">
					<div class="d-flex align-items-center">
						<span class="fg-oblivion ms-3">Habilidades que buscas: </span>
						<div class="d-flex align-items-center row-md-8 ms-3 flex-nowrap overflow-auto">
							<span class="badge rounded-pill bg-lushaqua p-2 pe-3 mx-2" id="badge1">
								<i hx-get="#del" hx-target="#badge1" hx-swap="delete" class="bi bi-x fs-5 badge-cancel"></i>
								Inglés
							</span>

							<span class="badge rounded-pill bg-lushaqua p-2 pe-3 mx-2">
								<i class="bi bi-x fs-5 badge-cancel"></i>
								Francés
							</span>
						</div>
					</div>
					<form>
						<input
							type="text"
							class="form-control rounded-pill bg-abaloneshell fg-oblivion p-2 ps-3 fg-oblivion"
							placeholder="Añadir habilidad">
					</form>
				</div>

				<div class="d-flex align-items-center mb-2 bg-abaloneshell-l0 p-2 rounded-pill justify-content-between">
					<div class="d-flex align-items-center">
						<span class="fg-oblivion ms-3">Habilidades que puedes ofrecer: </span>
						<div class="d-flex align-items-center row-md-8 ms-3 flex-nowrap overflow-auto">
							<span class="badge rounded-pill bg-orchid p-2 pe-3 mx-2">
								<i class="bi bi-x fs-5 badge-cancel"></i>
								Programación en Java
							</span>
							<span class="badge rounded-pill bg-orchid p-2 pe-3 mx-2">
								<i class="bi bi-x fs-5 badge-cancel"></i>
								Diseño gráfico
							</span>
							<span class="badge rounded-pill bg-orchid p-2 pe-3 mx-2">
								<i class="bi bi-x fs-5 badge-cancel"></i>
								Edición de fotografía
							</span>
							<span class="badge rounded-pill bg-orchid p-2 pe-3 mx-2">
								<i class="bi bi-x fs-5 badge-cancel"></i>
								Cocina
							</span>
						</div>
					</div>

					<form>
						<input
							type="text"
							class="form-control rounded-pill bg-abaloneshell fg-oblivion p-2 ps-3 fg-oblivion"
							placeholder="Añadir habilidad">
					</form>
				</div>

				<div class="row flex-nowrap overflow-auto mt-4">
					<div th:each="usr,i : ${users}" class="col-4 card mb-3 me-3 bg-oblivion" style="max-width: 450px; height: 275px;">
						<div class="row g-0 h-100">
							<div class="col-md-4 d-flex align-items-center justify-content-center">
								<img th:src="@{'/user/${usr.id}/pic'}" class="img-fluid rounded fg-abaloneshell" alt="Foto de perfil">
							</div>
							<div class="col-md-8">
								<div class="card-body p-0" style="height: 255px;">
									<div class="d-flex justify-content-between oblivion py-3 px-1">
										<span class="card-title fg-gold bold ps-3 fs-5" th:text="${usr.firstName}">Name</span>
										<button class="btn rounded bg-abaloneshell fg-oblivion bold p-1 ms-2 text-center"
											data-bs-toggle="modal"
											data-bs-target="#swapModal"
											th:attr="data-user-idx=${i}">
											Swap!
										</button>
									</div>
									<div class="fg-abaloneshell overflow-auto px-3">
										<p class="card-text fg-muted" th:text="${usr.description ?: 'Descripción no disponible'}">Description</p>
										<p class="card-text">
											<div class="row-md-8 mb-3">
												<span th:each="skill : ${usr.currentSkills != null ? usr.currentSkills : {}}" class="badge rounded-pill bg-lushaqua m-1"
													th:text="${skill}">Skill</span>
											</div>
											<div class="row-md-8">
												<span th:each="skill : ${usr.desiredSkills != null ? usr.desiredSkills : {}}" class="badge rounded-pill bg-orchid me-1"
													th:text="${skill}">Skill</span>
											</div>
										</p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				-->
				<h2 class="mt-5 fg-orchid bold">Habilidades más pedidas</h2>
				<hr class="hr-swp">
				<div id="carouseldHabilidadesPedidasCerca" class="carousel slide" data-bs-ride="carousel">
					<div class="carousel-inner">
						<div class="carousel-item active bg-orchid" data-bs-interval="5000" style="height: 300px;">
							<div class="d-flex justify-content-center align-items-center h-100">
								<span class="fg-gold bold fs-1">1. Inglés</span>
							</div>
						</div>
						<div class="carousel-item bg-gold" data-bs-interval="5000" style="height: 300px;">
							<div class="d-flex justify-content-center align-items-center h-100">
								<hspan1 class="fg-orchid bold fs-1">2. Programación</span>
							</div>
						</div>
						<div class="carousel-item bg-blendieblue" data-bs-interval="5000" style="height: 300px;">
							<div class="d-flex justify-content-center align-items-center h-100">
								<span class="fg-lushaqua bold fs-1">3. Español</span>
							</div>
						</div>
					</div>
					<button class="carousel-control-prev" type="button" data-bs-target="#carouseldHabilidadesPedidasCerca" data-bs-slide="prev">
						<span class="carousel-control-prev-icon" aria-hidden="true"></span>
						<span class="visually-hidden">Previous</span>
					</button>
					<button class="carousel-control-next" type="button" data-bs-target="#carouseldHabilidadesPedidasCerca" data-bs-slide="next">
						<span class="carousel-control-next-icon" aria-hidden="true"></span>
						<span class="visually-hidden">Next</span>
					</button>
				</div>
				<div class="container text-center overflow-hidden mt-5">
					<div class="row gap-3 text-center skills-row">
						<div th:each="skill : ${desiredSkills}"
							class="skill-card col py-2 px-4 bg-abaloneshell-l0 align-self-center fg-oblivion align-middle rounded bold d-flex justify-content-center align-items-center"
							style="height: 90px;">
							<span th:text="${skill}">Error</span>
						</div>
					</div>
					<div class="row gap-3 text-center skills-row my-3" style="animation-direction: reverse;">
						<div th:each="skill : ${desiredSkills}"
							class="skill-card col py-2 px-4 bg-abaloneshell-l0 align-self-center fg-oblivion align-middle rounded bold d-flex justify-content-center align-items-center"
							style="height: 90px;">
							<span th:text="${skill}">Error</span>
						</div>
					</div>
					<div class="row gap-3 text-center skills-row" style="animation-delay: -50s;">
						<div th:each="skill : ${desiredSkills}"
							class="skill-card col py-2 px-4 bg-abaloneshell-l0 align-self-center fg-oblivion align-middle rounded bold d-flex justify-content-center align-items-center"
							style="height: 90px;">
							<span th:text="${skill}">Error</span>
						</div>
					</div>
				</div>

				<h2 class="mt-5 fg-orchid bold">Usuarios que te podrian interesar</h2>
				<hr class="hr-swp">

				<div class="container mt-3 p-0">
					<div class="row row-cols-3 gap-3">
						<div th:each="usr,i : ${otherusers}" th:if="${i.index < 9}" class="card bg-oblivion" style="width: 419px; height: 265px;">
							<div class="d-flex h-100">
								<div class="col-md-4 d-flex align-items-center justify-content-center mb-3">
									<a th:href="@{/user/{userId}(userId=${usr.id})}">
										<img th:src="@{/user/{id}/pic(id=${usr.id})}" class="img-fluid rounded fg-abaloneshell" th:alt="${'Foto de perfil de' + usr.username}">
									</a>
								</div>
								<div class="col-md-8">
									<div class="card-body p-0" style="height: 245px;">
										<div class="d-flex justify-content-between oblivion py-3 px-1">
											<div class="d-flex flex-column">
												<a th:href="@{/user/{userId}(userId=${usr.id})}" class="text-decoration-none">
													<span class="card-title fg-gold bold ps-3 fs-5 username" th:text="${usr.firstName}">Name</span>
												</a>
												<a th:href="@{/user/{userId}(userId=${usr.id})}" class="text-decoration-none">
													<span class="card-title fg-muted ps-3 fs-6" th:text="${'@' + usr.username}">Name</span>
												</a>
											</div>
											<button class="btn rounded bg-abaloneshell fg-oblivion bold p-1 px-2 ms-2 text-center"
												data-bs-toggle="modal"
												data-bs-target="#swapModal"
												th:attr="data-user-idx=${i.index}">
												Swap!
											</button>
										</div>
										<div class="fg-abaloneshell overflow-auto px-3">
											<p class="card-text fg-muted" th:text="${usr.description}">Description</p>
											<p class="card-text">
												<div class="row-md-8 mb-3">
													<span th:each="cs : ${usr.currentSkills != null ? usr.currentSkills : {}}" class="badge rounded-pill bg-lushaqua m-1"
														th:text="${cs}">Skill</span>
												</div>
												<div class="row-md-8">
													<span th:each="ds : ${usr.desiredSkills != null ? usr.desiredSkills : {}}" class="badge rounded-pill bg-orchid me-1"
														th:text="${ds}">Skill</span>
												</div>
											</p>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<th:block th:if="${#lists.size(otherusers) > 9}">
						<div class="d-flex align-items-center my-4">
							<div class="flex-grow-1 load-more-line"></div>
							<button id="loadMoreUsersBtn" class="btn bg-abaloneshell-l1 fg-oblivion bold mx-3">
								Cargar más
							</button>
							<div class="flex-grow-1 load-more-line"></div>
						</div>
					</th:block>
					
				</div>

				<h2 class="mt-5 fg-orchid bold">Habilidades más comunes</h2>
				<hr class="hr-swp">
				<div id="carouseldHabilidadesComunesCerca" class="carousel slide">
					<div class="carousel-inner">
						<div class="carousel-item active bg-lushaqua" style="height: 300px;">
							<div class="d-flex justify-content-center align-items-center h-100">
								<h1 class="fg-gold bold">1. Español</h1>
							</div>
						</div>
						<div class="carousel-item bg-gold" style="height: 300px;">
							<div class="d-flex justify-content-center align-items-center h-100">
								<h1 class="fg-oblivion bold">2. Inglés</h1>
							</div>
						</div>
						<div class="carousel-item bg-orchid" style="height: 300px;">
							<div class="d-flex justify-content-center align-items-center h-100">
								<h1 class="fg-abaloneshell bold">3. Microsoft Office</h1>
							</div>
						</div>
					</div>
					<button class="carousel-control-prev" type="button" data-bs-target="#carouseldHabilidadesComunesCerca" data-bs-slide="prev">
						<span class="carousel-control-prev-icon" aria-hidden="true"></span>
						<span class="visually-hidden">Previous</span>
					</button>
					<button class="carousel-control-next" type="button" data-bs-target="#carouseldHabilidadesComunesCerca" data-bs-slide="next">
						<span class="carousel-control-next-icon" aria-hidden="true"></span>
						<span class="visually-hidden">Next</span>
					</button>
				</div>

				<div class="container my-5 text-center overflow-hidden">
					<div class="row gap-3 text-center skills-row">
						<div th:each="skill : ${commonSkills}"
							class="skill-card col py-2 px-4 bg-abaloneshell-l0 align-self-center fg-oblivion align-middle rounded bold d-flex justify-content-center align-items-center"
							style="height: 90px;">
							<span th:text="${skill}">Error</span>
						</div>
					</div>
					<div class="row gap-3 text-center skills-row my-3" style="animation-direction: reverse;">
						<div th:each="skill : ${commonSkills}"
							class="skill-card col py-2 px-4 bg-abaloneshell-l0 align-self-center fg-oblivion align-middle rounded bold d-flex justify-content-center align-items-center"
							style="height: 90px;">
							<span th:text="${skill}">Error</span>
						</div>
					</div>
					<div class="row gap-3 text-center skills-row" style="animation-delay: -50s;">
						<div th:each="skill : ${commonSkills}"
							class="skill-card col py-2 px-4 bg-abaloneshell-l0 align-self-center fg-oblivion align-middle rounded bold d-flex justify-content-center align-items-center"
							style="height: 90px;">
							<span th:text="${skill}">Error</span>
						</div>
					</div>
				</div>
			</div>
		</main>

		<!-- Swap Modal -->
		<div class="modal fade" id="swapModal" tabindex="-1" aria-labelledby="swapModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="swapModalLabel">Confirmar Swap</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div class="d-flex align-items-center">
							<img id="swapUserPic" class="img-fluid rounded me-3" style="width: 100px;" alt="Foto de perfil">
							<div>
								<h5 id="swapUserName"></h5>
								<p><strong>Habilidad:</strong> <span id="swapUserSkill"></span></p>
								<p><strong>Descripción:</strong> <span id="swapUserDesc"></span></p>
							</div>
						</div>
						<hr>
						<div>
							<h5>Tu Habilidad</h5>
							<p><strong>Habilidad:</strong> <span id="yourSkill"></span></p>
							<p><strong>Descripción:</strong> <span id="yourSkillDesc"></span></p>
						</div>
						<hr>
						<div>
							<label for="swapDate" class="form-label">Fecha:</label>
							<input type="date" id="swapDate" class="form-control">
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Volver</button>
						<button type="button" class="btn btn-primary" id="confirmSwap">Confirmar</button>
					</div>
				</div>
			</div>
		</div>

		<script>
			document.addEventListener("DOMContentLoaded", () => {
				const swapModal = document.getElementById("swapModal");
				const confirmSwapButton = document.getElementById("confirmSwap");

				swapModal.addEventListener("show.bs.modal", (event) => {
					const button = event.relatedTarget;
					const user = users[button.dataset.userIdx];
					console.log(button, user)

					document.getElementById("swapUserPic").src = `/img/pfp/${user.id}`;
					document.getElementById("swapUserName").textContent = user.name;
					document.getElementById("swapUserSkill").textContent = user.skill;
					document.getElementById("swapUserDesc").textContent = user.skill;

						// Fetch dinamicamente el skill y description del usuario
						fetch(`/users/${config.userId}/skills`)
							.then(response => response.json())
							.then(data => {
								document.getElementById("yourSkill").textContent = data.skillName || "Habilidad no disponible";
								document.getElementById("yourSkillDesc").textContent = data.skillDescription || "Descripción no disponible";
							})
							.catch(err => {
								console.error(err);
								document.getElementById("yourSkill").textContent = "Error al cargar habilidad";
								document.getElementById("yourSkillDesc").textContent = "Error al cargar descripción";
							});

					confirmSwapButton.setAttribute("data-user-id", user.id);
					// confirmSwapButton.setAttribute("data-user-skill-id", button.getAttribute("data-user-skill-id"));
				});

				confirmSwapButton.addEventListener("click", () => {

					if (!swapDate) {
						alert("Por favor, selecciona una fecha.");
						return;
					}

					const loggedInUserSkillId = config.loggedInUserSkillId;

					fetch("/swaps/create", {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
							"X-CSRF-TOKEN": config.csrf.value
						},
						body: JSON.stringify({
							userA: config.userId,
							userB: user.id,
							skillA: loggedInUserSkillId,
							skillB: userSkillId,
							swapDate: new Date().now(),
						})
					})
					.then(response => {
						if (response.ok) {
							alert("¡Swap creado con éxito!");
							location.reload();
						} else {
							return response.text().then(text => { throw new Error(text); });
						}
					})
					.catch(err => {
						console.error(err);
						alert("Error al crear el swap.");
					});
				});
			});
		</script>

		<th:block th:replace="fragments/footer.html :: footer" />
	</body>

</html>